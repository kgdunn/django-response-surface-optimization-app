{% extends "base.html" %}
{% load rsm_extras %}


{% block title %}{{ system.full_name }}{% endblock %}
{# ------------------------------------------------#}
{% block header %}
    <style type="text/css">
    .ui-input-text {
        width: 60% !important;
    }
    .rsm-input-suffix{
        padding-top: 10px;
    }
    .row-odd{
    background: #DDDDDD;
    }

    .expt-response{
        text-align: right;
    }
    .expt-input{
        text-align: center
    }
    </style>
    {% if not enabled %}
        <script type="text/javascript">
        $(function() {
            $("#rsm-expt-input").fadeTo( 2000, 0.33 );
        });
        </script>
    {% endif %}
{% endblock %}
{# ------------------------------------------------#}
{% block content %}
{{message|safe}}
<h2>{{ system.full_name }}</h2>
<p>{{system.description|safe|linebreaks}}
{% if input_set and not show_solution %}
<hr>
<h2>The next experiment</h2>
<div class="rsm-info">
    {% if data_html %}
        You have run {{ data_html|length }} experiment{{ data_html|length|pluralize }} already (see below). There are a maximum of {{system.max_experiments_allowed}} experiments allowed.
    {% endif %}
</div>

<div class="rsm-error input-error">{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}</div>
<div class="rsm-extra-info">{% if extra_information %}<p><strong>{{ extra_information }}</strong></p>{% endif %}</div>

{% if not enabled %}
    <p> You have to <a href="#sign-in-popup" id="sign-in-popup-link" data-rel="popup"
        class="ui-btn ui-btn-inline ui-corner-all ui-icon-gear ui-btn-icon-left"
        name="sign-in-popup-link">Sign-in</a> in order to run experiments on the website.
    <br>(We do not not use any passwords; we sign you in with a single email.)
{% endif %}

<div id="rsm-expt-input">
    <form action="{% url 'rsmapp:show_one_system' system.slug %}"
    method="post" data-ajax="false">
    {% csrf_token %}

    {% for item in input_set.all %}
        <div data-role="fieldcontain">
            <label for="{{item.slug}}">{{item.display_name}}: {{item.units_prefix}}</label>
            {% if item.ntype == "CON" %}
                <input type="text"
                       name="{{item.slug}}"
                       data-clear-btn="true"
                       data-inline="true"
                       {% if not enabled %}disabled="disabled"{% endif %}
                       size="7"
                       maxlength="7"
                       placeholder="{{item.default_value|get_floatformat:item.n_decimals}} (a typical value)"
                       {% if prior_values %}
                           value="{{ prior_values|get_item:item.slug|floatformat:2 }}"
                       {% endif %}
                       id="{{item.slug}}">
                {% elif item.ntype == "CAT" %}
                    <fieldset data-role="controlgroup">
                    {% for key, value in categoricals|dict_iteration:item.slug %}
                        <input type="radio"
                               name="{{item.slug}}"
                               {% if not enabled %}disabled="disabled"{% endif %}
                               value="{{key}}"
                               id="{{item.slug}}-{{forloop.counter}}"
                        {% if value == "__checked__" %}checked{% endif %}>
                        <label for="{{item.slug}}-{{forloop.counter}}">{{key}}</label>
                    {% endfor %}
                    </fieldset>
                {% endif %}
            <div class="rsm-input-suffix">{{item.units_suffix}}</div>
        </div>  <!--/fieldcontain-->

        <div data-role="fieldcontain"><label></label>
            <div class="rsm-extra-info" id="{{item.slug}}-error">{% if item.error_message%}({{item.error_message}}){% endif %}
            </div>
        </div><!--/fieldcontain-->
    {% endfor %}

    <p><input type="submit" {% if not enabled %}disabled="disabled"{% endif %} value="Run my next experiment!" />
    </form>

</div><!--/rsm-expt-input-->
{% endif %} {# if input_set #}
<hr>

{% if data_html %}

    <h2>Previous experiments run</h2>

        {{plot_html|safe}}

        {# Table of experimental results goes here #}

        <table class="expt-results" style="display: inline-block;">
            <tr>
            <th>Experiment<br>number</th>
            <th>Date and time</th>
            {% for item in input_set.all %}
                <th class="{{item.slug}}">{{item.display_name}}<br>
                  {% if item.ntype == "CON" %}[{{item.units_prefix}}{{item.units_suffix}}]{% endif %}
                </th>
            {% endfor %}
            <th>{{system.primary_output_display_name_with_units}}</th>
            </tr>

            {% for expt in data_html %}
            {%spaceless%}
            <tr class="row-{% cycle 'odd' 'even' %} expt-result" id="rsm-result-{{forloop.counter}}">
                <td class="expt-number">{{forloop.counter}}</td>
                <td class="datetime">{{expt.datetime|date:"d M Y H:i:s"}}</td>
                {% for item in input_set.all %}
                    <td class="expt-input">{{expt.inputs|get_item:item.slug}}</td>
                {% endfor %}
                <td class="expt-response">{{expt.output|floatformat:0}}</td>
            </tr>
            {% endspaceless %}
            {% endfor %}
        </table>

<script type="text/javascript">
    var closePopup = function(event){
        $('#reset-popup').popup("close");
        event.preventDefault();
        };
    $(function() {
        $('#reset-popup-form').submit(function(event) {
            var form = $(this);

            $.ajax({
                type: form.attr('method'),
                url:  form.attr('action'),
                cache: false,
                data: form.serialize(),
                dataType: "html",
                beforeSend: function( xhr ) {
                }
            }).done(function(data) {
                window.location.replace("{% url 'rsmapp:show_one_system' system.slug %}")
            }).fail(function(data) {
            }).always(function(data){
            });
            event.preventDefault();
        });
    });
</script>
<script type="text/javascript">
    var closePopup = function(event){
        $('#solution-popup').popup("close");
        event.preventDefault();
        };
    $(function() {
        $('#solution-popup-form').submit(function(event) {
            var form = $(this);

            $.ajax({
                type: form.attr('method'),
                url:  form.attr('action'),
                cache: false,
                data: form.serialize(),
                dataType: "html",
                beforeSend: function( xhr ) {
                }
            }).done(function(data) {
                window.location.replace("{% url 'rsmapp:show_one_system' system.slug %}")
            }).fail(function(data) {
            }).always(function(data){
            });
            event.preventDefault();
        });
    });
</script>
<div class="rsm-reset-button">
    <div data-role="main" class="ui-content">
        <a href="#reset-popup" id="reset-link" data-rel="popup" class="ui-btn ui-icon ui-btn-inline ui-corner-all ui-icon-gear ui-btn-icon-left" name="reset-popup-link">
        Clear all above experiments
        </a>
        <div data-role="popup" id="reset-popup" class="ui-content" data-transition="pop" style="min-width:250px;">
            <form method="post" id="reset-popup-form" action="{% url 'rsmapp:reset_one_system' system.slug %}" name="reset-popup-form">
                {% csrf_token %}
                <div>
                    <h3>Are you sure?</h3>
                    This will clear all experiments for this system and start from a fresh baseline experiment.<br>

                    <input id="popup-delete-submit-button" type="submit" data-rel="back" data-inline="true" value="Delete all the above experiments!">
                    <span id="popup-Cancel-span" style="float: right"><input id="popup-Cancel-button" type="button" data-inline="true" value="Cancel" onclick="closePopup()"></span>
                </div>
            </form>
        </div>
    </div>
</div>

{% if not show_solution %}
    <div class="rsm-solution-button">
        <div data-role="main" class="ui-content">
            <a href="#solution-popup" id="solution-link" data-rel="popup" class="ui-btn ui-icon ui-btn-inline ui-corner-all ui-icon-eye ui-btn-icon-left red" name="solution-popup-link">
            Show solution for this system
            </a>
            <div data-role="popup" id="solution-popup" class="ui-content" data-transition="pop" style="min-width:250px;">
                <form method="post" id="solution-popup-form" action="{% url 'rsmapp:show_solution_one_system' system.slug %}" name="solution-popup-form">
                    {% csrf_token %}
                    <div>
                        <h3>Are you sure?</h3>
                        This will reveal the true solution for the system.<br>

                        <input id="popup-solution-submit-button" type="submit" data-rel="back" data-inline="true" value="Show solution for this system!">
                        <span id="popup-Cancel-span" style="float: right"><input id="popup-Cancel-button" type="button" data-inline="true" value="Cancel" onclick="closePopup()"></span>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endif %}

{% endif %} {# CHECK THAT THIS MATCHES WITH THE START #}
{% endblock %}